<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--accent:#276ef1;--muted:#666}
        html,body{height:100%;margin:0;font-family:'DM Sans',system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f7f9ff;color:#111}
        .wrap{max-width:880px;margin:40px auto;padding:24px;background:white;border-radius:12px;box-shadow:0 6px 30px rgba(34,60,80,0.06)}
        h1{margin:0 0 8px;font-size:20px}
        .meta{color:var(--muted);font-size:14px;margin-bottom:18px}
        .level-pill{display:inline-block;padding:6px 10px;background:#eef4ff;border-radius:999px;color:var(--accent);font-weight:600;margin-bottom:12px}
        .q-card{padding:18px;border-radius:8px;background:#fbfdff;border:1px solid #eef6ff}
        .question{font-size:18px;margin:0 0 12px}
        .choices{list-style:none;padding:0;margin:0 0 12px}
        .choices li{margin-bottom:8px}
        .choice-btn{display:block;width:100%;text-align:left;padding:10px 12px;border-radius:8px;border:1px solid #e6eefc;background:white;cursor:pointer}
        .choice-btn:hover{background:#f3f7ff}
        .controls{display:flex;gap:8px;flex-wrap:wrap}
        button.btn{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
        button.secondary{background:#eef2ff;color:var(--accent);border:1px solid #dbe9ff}
        button.ghost{background:transparent;border:1px dashed #d0d7ee;color:var(--muted)}
        .feedback{margin-top:10px;font-weight:600}
        .small{font-size:13px;color:var(--muted)}
    </style>
</head>
<body>
<main class="wrap">
    <h1>Diagnostic Quiz (Grades K–8)</h1>
    <div class="meta">Adaptive quiz: answer correctly to get harder questions. Use "I don't know" for another question at this level, or "I haven't learned this yet" to skip.</div>

    <div id="app">
        <div class="level-pill" id="levelLabel">Level: K</div>
        <div class="q-card">
            <p class="question" id="questionText">Loading...</p>
            <ul class="choices" id="choices"></ul>

            <div class="controls">
                <button class="secondary" id="idkBtn">I don't know</button>
                <button class="ghost" id="notLearnedBtn">I haven't learned this yet</button>
            </div>

            <div class="feedback" id="feedback"></div>
            <div class="small" id="progress"></div>
        </div>
    </div>
</main>

<script>
    const levels = ['K','1','2','3','4','5','6','7','8'];

    const bank = {
        'K': [
            {q:'What number comes after 2?', choices:['1','2','3','4'], correct:2},
            {q:'How many sides does a triangle have?', choices:['2','3','4','5'], correct:1},
            {q:'Which shape is a circle?', choices:['square','triangle','circle','rectangle'], correct:2}
        ],
        '1': [
            {q:'What is 2 + 3?', choices:['4','5','6','3'], correct:1},
            {q:'What is 5 - 2?', choices:['1','2','3','4'], correct:2},
            {q:'Which number is even?', choices:['3','7','8','5'], correct:2}
        ],
        '2': [
            {q:'What is 7 - 4?', choices:['2','3','4','5'], correct:1},
            {q:'What is 3 × 2?', choices:['6','5','8','9'], correct:0},
            {q:'What is 10 ÷ 2?', choices:['2','3','4','5'], correct:3}
        ],
        '3': [
            {q:'What is 6 × 3?', choices:['18','16','12','9'], correct:0},
            {q:'What is 12 ÷ 4?', choices:['2','3','4','6'], correct:1},
            {q:'What is 15 - 7?', choices:['7','8','9','6'], correct:1}
        ],
        '4': [
            {q:'What is 12 ÷ 3?', choices:['3','4','5','6'], correct:1},
            {q:'What is 9 × 5?', choices:['45','35','40','50'], correct:0},
            {q:'What is 25 + 17?', choices:['42','43','41','40'], correct:0}
        ],
        '5': [
            {q:'What is 8 × 7?', choices:['54','56','48','63'], correct:1},
            {q:'What is 45 ÷ 9?', choices:['5','6','7','9'], correct:0},
            {q:'What is 3/4 of 8?', choices:['5','6','7','4'], correct:1}
        ],
        '6': [
            {q:'What is 2^3?', choices:['6','8','9','4'], correct:1},
            {q:'What is 18 ÷ 3?', choices:['6','5','7','9'], correct:0},
            {q:'What is the mean of 2, 4, 6?', choices:['3','4','5','6'], correct:1}
        ],
        '7': [
            {q:'What is 3/4 + 1/4?', choices:['1/2','1','3/4','4/4'], correct:1},
            {q:'What is 7 × (2 + 3)?', choices:['35','21','25','30'], correct:0},
            {q:'What is 2/3 of 15?', choices:['10','8','9','7'], correct:0}
        ],
        '8': [
            {q:'Solve for x: 2x + 3 = 11', choices:['4','5','6','3'], correct:0},
            {q:'Simplify: 3(x + 2) when x = 4', choices:['12','18','14','16'], correct:1},
            {q:'Evaluate: 5(2) - 3^2', choices:['1','7','-1','10'], correct:0}
        ]
    };

    let curLevelIdx = 0; // start at 'K'
    let curQIdx = 0; // index within level array (we'll use as difficulty order)
    const results = {};

    const levelLabel = document.getElementById('levelLabel');
    const questionText = document.getElementById('questionText');
    const choicesEl = document.getElementById('choices');
    const idkBtn = document.getElementById('idkBtn');
    const notLearnedBtn = document.getElementById('notLearnedBtn');
    const feedback = document.getElementById('feedback');
    const progress = document.getElementById('progress');

    function updateProgress(){
        const level = levels[curLevelIdx];
        progress.textContent = `Level ${level} — question ${curQIdx+1} of ${bank[level].length}`;
    }

    function loadQuestion(){
        const level = levels[curLevelIdx];
        const qObj = bank[level][curQIdx];
        levelLabel.textContent = `Level: ${level}`;
        questionText.textContent = qObj.q;
        choicesEl.innerHTML = '';
        qObj.choices.forEach((c,i)=>{
            const li = document.createElement('li');
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.type = 'button';
            btn.dataset.index = i;
            btn.textContent = c;
            btn.onclick = ()=>{
                // submit answer immediately on click
                submitAnswer(i);
            };
            li.appendChild(btn);
            choicesEl.appendChild(li);
        });
        feedback.textContent = '';
        updateProgress();
    }

    function nextQuestionSameLevel(repeat=false){
        const level = levels[curLevelIdx];
        if(!repeat){
            // move to next question index if available
            if(curQIdx < bank[level].length -1){
                curQIdx++;
            } else {
                // all questions attempted and answered — advance level
                return nextLevel();
            }
        } else {
            // pick a different question index at same level
            const choices = [...Array(bank[level].length).keys()].filter(i=>i!==curQIdx);
            curQIdx = choices[Math.floor(Math.random()*choices.length)];
        }
        loadQuestion();
    }

        function submitAnswer(selectedIndex){
            const level = levels[curLevelIdx];
            const qObj = bank[level][curQIdx];
            const sel = selectedIndex;
            if(!results[level]) results[level] = {score:0, notLearned:false, wrongIndices:[]};
            if(sel === qObj.correct){
                feedback.textContent = 'Correct! Moving to a harder question.';
                results[level].score++;
                // attempt harder question (next in order) or advance level
                setTimeout(()=> nextQuestionSameLevel(false),700);
            } else {
                // record this question index as wrong (unique)
                if(!results[level].wrongIndices.includes(curQIdx)) results[level].wrongIndices.push(curQIdx);
                // if all questions for this level have been answered incorrectly, end early
                if(results[level].wrongIndices.length >= bank[level].length){
                    // show ending screen indicating the student doesn't know this level yet
                    setTimeout(()=> showUnknown(level),300);
                    return;
                }
                feedback.textContent = 'Incorrect — try another question at this level or choose "I haven\'t learned this yet".';
                // present another question at same level (random different)
                setTimeout(()=> nextQuestionSameLevel(true),800);
            }
        }

    function handleIDK(){
        feedback.textContent = 'No problem — here is another question at this level.';
        nextQuestionSameLevel(true);
    }

    function handleNotLearned(){
        const level = levels[curLevelIdx];
        if(!results[level]) results[level] = {score:0, notLearned:true};
        else results[level].notLearned = true;
        feedback.textContent = 'Marked as not learned — moving to the next level.';
        setTimeout(()=> nextLevel(),700);
    }

    function nextLevel(){
        if(curLevelIdx < levels.length -1){
            curLevelIdx++;
            curQIdx = 0;
            loadQuestion();
        } else {
            // finished all levels
            showSummary();
        }
    }

    function showSummary(){
        // Build summary header
        document.getElementById('app').innerHTML = `<h2>Quiz complete</h2><p class="small">Summary:</p>`;
        const wrap = document.createElement('div');

        // Add per-level results
        Object.keys(bank).forEach(l=>{
            const res = results[l] || {score:0,notLearned:false};
            const p = document.createElement('p');
            p.className='small';
            p.textContent = `Level ${l}: score ${res.score}/${bank[l].length}` + (res.notLearned? ' — not learned':'');
            wrap.appendChild(p);
        });

        // Recommendation logic:
        // 1) Prefer the highest level where student scored >= 2/3 of questions and didn't mark "not learned".
        // 2) If none, pick the level with the highest raw score.
        let recommended = null;
        // look for highest level meeting threshold
        for(let i=levels.length-1;i>=0;i--){
            const lvl = levels[i];
            const res = results[lvl] || {score:0,notLearned:false};
            if(!res.notLearned && res.score >= Math.ceil(bank[lvl].length * 0.66)){
                recommended = lvl;
                break;
            }
        }

        if(!recommended){
            // pick level with highest score (tie -> lowest level index)
            let bestScore = -1; let bestLevel = levels[0];
            for(const l of levels){
                const res = results[l] || {score:0};
                if(res.score > bestScore){ bestScore = res.score; bestLevel = l; }
            }
            recommended = bestLevel;
        }

        const recP = document.createElement('p');
        recP.style.marginTop = '12px';
        recP.innerHTML = `<strong>Recommended starting level:</strong> ${recommended} <span class="small">(based on your answers)</span>`;
        wrap.insertBefore(recP, wrap.firstChild);

        document.getElementById('app').appendChild(wrap);
    }

    function showUnknown(level){
        document.getElementById('app').innerHTML = `<h2>Quiz complete</h2><p class="small">You answered all questions at level ${level} incorrectly.</p><p class="small">It looks like you don't know this level yet. Consider starting at a lower level or reviewing the topics before retrying.</p>`;
    }

    idkBtn.addEventListener('click', handleIDK);
    notLearnedBtn.addEventListener('click', handleNotLearned);

    // initial load
    loadQuestion();

</body>
</html>
