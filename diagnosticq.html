<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="style.css">

 
</head>
<body>
     <nav>
    <div class="nav-container">
      <div class="logo">
        <img src="logo.png" alt="Student Math Mentors Logo" width="80" height="70" class="navbar" /> </li>
      </div>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="services.html">Services</a></li>
        <li><a href="volunteer.html">Volunteer</a></li>
        <li><a href="resources.html">Resources</a></li>
        <li><a href="contact.html" class="btn-login">Get Started</a></li>
      </ul>
    </div>
    </nav>
<main class="wrap">
    <h1>Diagnostic Quiz (Grades K–8)</h1>
    <div class="meta">Adaptive quiz: answer correctly to get harder questions. Use "I don't know" for another question at this level, or "I haven't learned this yet" to skip.</div>

    <div id="app">
        <div class="level-pill" id="levelLabel">Level: K</div>
        <div class="q-card">
            <p class="question" id="questionText">Loading...</p>
            <ul class="choices" id="choices"></ul>

            <div class="controls">
                <button class="secondary" id="idkBtn">I don't know</button>
                <button class="ghost" id="notLearnedBtn">I haven't learned this yet</button>
            </div>

            <div class="feedback" id="feedback"></div>
            <div class="small" id="progress"></div>
        </div>
    </div>
</main>

<script>
    const levels = ['K','1','2','3','4','5','6','7','8'];

    const bank = {
        'K': [
            {q:'What number comes after 2?', choices:['1','2','3','4'], correct:2},
            {q:'How many sides does a triangle have?', choices:['2','3','4','5'], correct:1},
            {q:'Which shape is a circle?', choices:['square','triangle','circle','rectangle'], correct:2}
        ],
        '1': [
            {q:'What is 2 + 3?', choices:['4','5','6','3'], correct:1},
            {q:'What is 5 - 2?', choices:['1','2','3','4'], correct:2},
            {q:'Which number is even?', choices:['3','7','8','5'], correct:2}
        ],
        '2': [
            {q:'What is 7 - 4?', choices:['2','3','4','5'], correct:1},
            {q:'What is 3 × 2?', choices:['6','5','8','9'], correct:0},
            {q:'What is 10 ÷ 2?', choices:['2','3','4','5'], correct:3}
        ],
        '3': [
            {q:'What is 6 × 3?', choices:['18','16','12','9'], correct:0},
            {q:'What is 12 ÷ 4?', choices:['2','3','4','6'], correct:1},
            {q:'What is 15 - 7?', choices:['7','8','9','6'], correct:1}
        ],
        '4': [
            {q:'What is 12 ÷ 3?', choices:['3','4','5','6'], correct:1},
            {q:'What is 9 × 5?', choices:['45','35','40','50'], correct:0},
            {q:'What is 25 + 17?', choices:['42','43','41','40'], correct:0}
        ],
        '5': [
            {q:'What is 8 × 7?', choices:['54','56','48','63'], correct:1},
            {q:'What is 45 ÷ 9?', choices:['5','6','7','9'], correct:0},
            {q:'What is 3/4 of 8?', choices:['5','6','7','4'], correct:1}
        ],
        '6': [
            {q:'What is 2^3?', choices:['6','8','9','4'], correct:1},
            {q:'What is 18 ÷ 3?', choices:['6','5','7','9'], correct:0},
            {q:'What is the mean of 2, 4, 6?', choices:['3','4','5','6'], correct:1}
        ],
        '7': [
            {q:'What is 3/4 + 1/4?', choices:['1/2','1','3/4','4/4'], correct:1},
            {q:'What is 7 × (2 + 3)?', choices:['35','21','25','30'], correct:0},
            {q:'What is 2/3 of 15?', choices:['10','8','9','7'], correct:0}
        ],
        '8': [
            {q:'Solve for x: 2x + 3 = 11', choices:['4','5','6','3'], correct:0},
            {q:'Simplify: 3(x + 2) when x = 4', choices:['12','18','14','16'], correct:1},
            {q:'Evaluate: 5(2) - 3^2', choices:['1','7','-1','10'], correct:0}
        ]
    };

    let curLevelIdx = 0; // start at 'K'
    let curQIdx = 0; // index within level array (we'll use as difficulty order)
    const results = {};

    const levelLabel = document.getElementById('levelLabel');
    const questionText = document.getElementById('questionText');
    const choicesEl = document.getElementById('choices');
    const idkBtn = document.getElementById('idkBtn');
    const notLearnedBtn = document.getElementById('notLearnedBtn');
    const feedback = document.getElementById('feedback');
    const progress = document.getElementById('progress');

    window.addEventListener('error', function(ev){
        console.error('Uncaught error:', ev.error || ev.message || ev);
        feedback.textContent = 'An unexpected error occurred.';
    });
    window.addEventListener('unhandledrejection', function(ev){
        console.error('Unhandled promise rejection:', ev.reason);
        feedback.textContent = 'An unexpected error occurred.';
    });

    function updateProgress(){
        const level = levels[curLevelIdx];
        progress.textContent = `Level ${level} — question ${curQIdx+1} of ${bank[level].length}`;
    }

    function loadQuestion(){
        try{
            const level = levels[curLevelIdx];
            levelLabel.textContent = `Level: ${level}`;

            if(!Array.isArray(levels) || levels.length === 0){
                questionText.textContent = 'No levels configured.';
                feedback.textContent = 'Error: levels array is empty or missing.';
                console.error('levels is invalid', levels);
                return;
            }

            if(!bank || typeof bank !== 'object'){
                questionText.textContent = 'Question bank missing.';
                feedback.textContent = 'Error: question bank is not available.';
                console.error('bank is invalid', bank);
                return;
            }

            if(!bank[level]){
                questionText.textContent = 'No questions found for this level.';
                feedback.textContent = `Error: question bank missing for level ${level}.`;
                console.error('Question bank missing for level:', level);
                return;
            }

            const qArr = bank[level];
            if(curQIdx < 0 || curQIdx >= qArr.length){
                questionText.textContent = 'No question available.';
                feedback.textContent = `Error: question index ${curQIdx} not found for level ${level}.`;
                console.error('Question object missing:', {level, curQIdx});
                return;
            }

            const qObj = qArr[curQIdx];
            if(!qObj || !Array.isArray(qObj.choices)){
                questionText.textContent = 'Invalid question format.';
                feedback.textContent = 'Error: question data malformed.';
                console.error('Invalid question object', qObj);
                return;
            }

            questionText.textContent = qObj.q;
            choicesEl.innerHTML = '';
            qObj.choices.forEach((c,i)=>{
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.type = 'button';
                btn.dataset.index = i;
                btn.textContent = c;
                btn.onclick = ()=> submitAnswer(i);
                li.appendChild(btn);
                choicesEl.appendChild(li);
            });
            feedback.textContent = '';
            updateProgress();
        }catch(err){
            console.error('loadQuestion failed', err);
            questionText.textContent = 'Failed to load question.';
            feedback.textContent = 'An error occurred while loading the question. See console for details.';
        }
    }

    function nextQuestionSameLevel(repeat=false){
        const level = levels[curLevelIdx];
        if(!repeat){
            if(curQIdx < bank[level].length -1){
                curQIdx++;
            } else {
                return nextLevel();
            }
        } else {
            const choices = [...Array(bank[level].length).keys()].filter(i=>i!==curQIdx);
            curQIdx = choices[Math.floor(Math.random()*choices.length)];
        }
        loadQuestion();
    }

        function submitAnswer(selectedIndex){
            const level = levels[curLevelIdx];
            const qObj = bank[level][curQIdx];
            const sel = selectedIndex;
            if(!results[level]) results[level] = {score:0, notLearned:false, wrongIndices:[]};
            if(sel === qObj.correct){
                feedback.textContent = 'Correct! Moving to a harder question.';
                results[level].score++;
                setTimeout(()=> nextQuestionSameLevel(false),700);
            } else {
                if(!results[level].wrongIndices.includes(curQIdx)) results[level].wrongIndices.push(curQIdx);
                if(results[level].wrongIndices.length >= bank[level].length){
                    setTimeout(()=> showUnknown(level),300);
                    return;
                }
                feedback.textContent = 'Incorrect — try another question at this level or choose "I haven\'t learned this yet".';
                setTimeout(()=> nextQuestionSameLevel(true),800);
            }
        }

    function handleIDK(){
        feedback.textContent = 'No problem — here is another question at this level.';
        nextQuestionSameLevel(true);
    }

    function handleNotLearned(){
        const level = levels[curLevelIdx];
        if(!results[level]) results[level] = {score:0, notLearned:true};
        else results[level].notLearned = true;
        feedback.textContent = 'Marked as not learned — moving to the next level.';
        setTimeout(()=> nextLevel(),700);
    }

    function nextLevel(){
        if(curLevelIdx < levels.length -1){
            curLevelIdx++;
            curQIdx = 0;
            loadQuestion();
        } else {
            showSummary();
        }
    }

    function showSummary(){
        document.getElementById('app').innerHTML = `<h2>Quiz complete</h2><p class="small">Summary:</p>`;
        const wrap = document.createElement('div');

        Object.keys(bank).forEach(l=>{
            const res = results[l] || {score:0,notLearned:false};
            const p = document.createElement('p');
            p.className='small';
            p.textContent = `Level ${l}: score ${res.score}/${bank[l].length}` + (res.notLearned? ' — not learned':'');
            wrap.appendChild(p);
        });

       
        let recommended = null;
        for(let i=levels.length-1;i>=0;i--){
            const lvl = levels[i];
            const res = results[lvl] || {score:0,notLearned:false};
            if(!res.notLearned && res.score >= Math.ceil(bank[lvl].length * 0.66)){
                recommended = lvl;
                break;
            }
        }

        if(!recommended){
            let bestScore = -1; let bestLevel = levels[0];
            for(const l of levels){
                const res = results[l] || {score:0};
                if(res.score > bestScore){ bestScore = res.score; bestLevel = l; }
            }
            recommended = bestLevel;
        }

        const recP = document.createElement('p');
        recP.style.marginTop = '12px';
        recP.innerHTML = `<strong>Recommended starting level:</strong> ${recommended} <span class="small">(based on your answers)</span>`;
        wrap.insertBefore(recP, wrap.firstChild);

        document.getElementById('app').appendChild(wrap);
    }

    function showUnknown(level){
        const idx = levels.indexOf(level);
        const prevIdx = idx - 1;
        let recommendedLevel = null;
        if(prevIdx >= 0){
            const prev = levels[prevIdx];
            const prevRes = results[prev] || {score:0};
            if(prevRes.score >= 1) recommendedLevel = prev;
        }

        const resourcesLink = 'resources.html';
        const recommendedLink = recommendedLevel ? `resources-${(recommendedLevel==='K'?'k':recommendedLevel)}.html` : null;

        let html = `<h2>Quiz complete</h2><p class="small">You answered all questions at level ${level} incorrectly.</p>`;
        if(recommendedLevel){
            html += `<p class="small">Based on your answers at the lower level, we recommend starting at level ${recommendedLevel}.</p>`;
        } else if(prevIdx >= 0){
            html += `<p class="small">It looks like you don't know this level yet. Consider starting at level ${levels[prevIdx]} or reviewing the topics before retrying.</p>`;
        } else {
            html += `<p class="small">It looks like you don't know this level yet. Consider reviewing the topics before retrying.</p>`;
        }

        html += `<p style="margin-top:12px"><a class="btn-primary" href="${resourcesLink}">Back to Resources</a>`;
        if(recommendedLink){
            html += `<a class="btn-primary" href="${recommendedLink}">Go to Level ${recommendedLevel} Resources</a>`;
        }
        html += `</p>`;

        document.getElementById('app').innerHTML = html;
    }

    idkBtn.addEventListener('click', handleIDK);
    notLearnedBtn.addEventListener('click', handleNotLearned);
    try{
        loadQuestion();
    }catch(e){
        console.error('Initial loadQuestion threw', e);
        feedback.textContent = 'Initialization error — check console.';
    }
</script>
</body>

